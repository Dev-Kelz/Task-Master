{% extends 'base.html' %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tasks.css') }}">
<meta name="description" content="Task Master - Manage your tasks efficiently">
{% endblock %}

{% block content %}
<div class="container">

    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h1 class="card-title text-center mb-4">Task Master</h1>
                    <p class="text-muted text-center">Welcome back, {{ current_user.username }}! Here are your tasks.</p>

                    {% if tasks|length < 1 %}
                    <div class="alert alert-info" role="alert">
                        You don't have any tasks yet. Create your first task below!
                    </div>
                    {% else %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width: 80px;">Status</th>
                                    <th>Task Details</th>
                                    <th>Task Date</th>
                                    <th class="text-center" style="width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in tasks %}
                                <tr class="task-item {% if task.completed %}table-light{% endif %}">
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input m-0" type="checkbox" 
                                                   style="width: 1.2em; height: 1.2em;"
                                                   {% if task.completed %}checked{% endif %}
                                                   onclick="window.location.href='{{ url_for('toggle_complete', id=task.id) }}';"
                                                   id="task-{{ task.id }}">
                                            <label class="form-check-label d-none" for="task-{{ task.id }}">Complete</label>
                                        </div>
                                    </td>
                                    <td class="{% if task.completed %}task-completed{% endif %}" style="min-width: 250px;">
                                        <div class="task-content">
                                            <div class="fw-semibold mb-1">{{ task.content[:100] }}{% if task.content|length > 100 %}...{% endif %}</div>
                                            {% if task.content|length > 100 %}
                                                <div class="task-description text-muted small mt-1">
                                                    {{ task.content[100:] }}
                                                </div>
                                            {% endif %}
                                            {% if task.completed and task.date_completed %}
                                                <div class="completed-date text-muted small mt-1">
                                                    <i class="fas fa-check-circle me-1"></i>Completed {{ task.date_completed.strftime('%b %d, %Y') }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="align-middle">{{ task.date_created.strftime('%b %d, %Y') }}</td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center gap-3">
                                            <a href="{{ url_for('update', id=task.id) }}" 
                                               class="btn btn-primary btn-sm"
                                               data-bs-toggle="tooltip" 
                                               title="Edit task">
                                                <i class="fas fa-edit me-1"></i> Edit
                                            </a>
                                            <a href="{{ url_for('delete', id=task.id) }}" 
                                               class="btn btn-danger btn-sm"
                                               data-bs-toggle="tooltip"
                                               title="Delete task"
                                               onclick="return confirm('Are you sure you want to delete this task? This action cannot be undone.')">
                                                <i class="fas fa-trash-alt me-1"></i> Delete
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">Add New Task</h5>
                    <form method="POST" class="needs-validation" novalidate>
                        {{ form.hidden_tag() }}
                        <div class="input-group">
                            {{ form.content(class="form-control", placeholder="Enter task description", 
                                         id="taskContent", required=True, minlength="3", maxlength="200",
                                         aria_label="Task description") }}
                            {{ form.submit(class="btn btn-primary", id="submitBtn") }}
                        </div>
                        {% if form.content.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.content.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Bootstrap JS for form validation -->
<script>
// Form validation and submission handling
document.addEventListener('DOMContentLoaded', function() {
    'use strict';
    
    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    const forms = document.querySelectorAll('.needs-validation');
    
    // Loop over forms and add validation
    Array.from(forms).forEach(function(form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            } else {
                // Show loading state
                const submitBtn = form.querySelector('#submitBtn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding...';
                    
                    // Revert button state if form submission fails
                    setTimeout(() => {
                        if (!document.body.contains(document.querySelector('.alert-danger'))) {
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                        }
                    }, 5000);
                }
            }
            
            form.classList.add('was-validated');
        }, false);
    });
    
    // Auto-focus the task input on page load
    const taskInput = document.getElementById('taskContent');
    if (taskInput) {
        taskInput.focus();
    }
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
